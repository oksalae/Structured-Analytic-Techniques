<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cone of Plausibilities</title>
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --border: #2d3a4d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --radius: 8px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 40px;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 1.25rem;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.85rem;
    }
    .back-link:hover { color: var(--accent); }

    .columns-header {
      display: grid;
      grid-template-columns: 1fr 1.2fr 1.8fr;
      column-gap: 24px;
      margin-bottom: 16px;
    }
    .col-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--accent);
      padding-bottom: 0.6rem;
      border-bottom: 2px solid var(--border);
    }

    .group-row {
      display: grid;
      grid-template-columns: 1fr 1.2fr 1.8fr;
      column-gap: 24px;
      align-items: stretch;
      margin-bottom: 20px;
    }

    .driver-card {
      padding: 18px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
    }

    .trends-stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .trend-card {
      min-height: 54px;
      display: flex;
      align-items: center;
      padding: 10px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.84rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
      overflow: hidden;
    }
    .trend-card:hover {
      border-color: var(--accent);
      color: var(--text);
    }
    .trend-card.selected {
      border-color: var(--accent);
      background: rgba(88, 166, 255, 0.08);
      color: var(--text);
    }
    .trend-text {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.35;
    }

    .scenario-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }
    .scenario-panel .no-trend {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.85rem;
      padding: 8px 0;
    }
    .scenario-group { display: flex; flex-direction: column; gap: 4px; }
    .scenario-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-muted);
    }
    .help-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      font-size: 0.7rem;
      font-weight: 700;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
      flex-shrink: 0;
      position: relative;
    }
    .help-btn:hover { border-color: var(--accent); color: var(--accent); }
    .help-tooltip {
      display: none;
      position: absolute;
      left: 24px;
      top: -4px;
      background: #232d3f;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.78rem;
      font-weight: 400;
      color: var(--text);
      white-space: normal;
      width: 260px;
      z-index: 10;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      line-height: 1.4;
    }
    .help-btn.active .help-tooltip { display: block; }
    .scenario-input {
      width: 100%;
      min-height: 48px;
      padding: 8px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: inherit;
      font-size: 0.84rem;
      resize: vertical;
      line-height: 1.4;
    }
    .scenario-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 1.25rem;
    }
    .btn-import {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-muted);
      font-family: inherit;
      font-size: 0.84rem;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
    }
    .btn-import:hover {
      border-color: var(--accent);
      color: var(--text);
    }

    /* Modal overlay & panel */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100;
      justify-content: center;
      align-items: flex-start;
      padding: 48px 24px;
      overflow-y: auto;
    }
    .modal-overlay.open { display: flex; }
    .modal-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 100%;
      max-width: 640px;
      padding: 28px 32px 24px;
      box-shadow: 0 12px 48px rgba(0,0,0,0.5);
    }
    .modal-title {
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--accent);
      line-height: 1.35;
    }
    .modal-field { margin-bottom: 14px; }
    .modal-field label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .modal-field input,
    .modal-field textarea,
    .modal-field select {
      width: 100%;
      padding: 8px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: inherit;
      font-size: 0.84rem;
      line-height: 1.4;
    }
    .modal-field textarea { min-height: 64px; resize: vertical; }
    .modal-field input:focus,
    .modal-field textarea:focus,
    .modal-field select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .modal-field a.source-link {
      display: inline-block;
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--accent);
      word-break: break-all;
    }
    .modal-field a.source-link:hover { text-decoration: underline; }
    .modal-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .modal-h-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 14px;
    }
    .modal-h-row .modal-field { margin-bottom: 0; }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .modal-btn {
      padding: 8px 22px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-muted);
      font-family: inherit;
      font-size: 0.84rem;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
    }
    .modal-btn:hover { border-color: var(--accent); color: var(--text); }
    .modal-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #0f1419;
      font-weight: 600;
    }
    .modal-btn.primary:hover { background: #79b8ff; border-color: #79b8ff; }

    #content { display: none; }
    .loading {
      color: var(--text-muted);
      padding: 2rem 0;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <a class="back-link" href="http://localhost:3000" style="margin-bottom:0">&larr; Back to Hub</a>
    <button class="btn-import" id="btnReadFile" type="button">&#8635; Read from File</button>
  </div>
  <p class="loading" id="loadingMsg">Loading drivers and trends&hellip;</p>

  <div id="content">
    <div class="columns-header">
      <div class="col-title">Drivers</div>
      <div class="col-title">Trends</div>
      <div class="col-title">Scenarios</div>
    </div>
    <div id="rows"></div>
  </div>

  <div class="modal-overlay" id="trendModal">
    <div class="modal-panel">
      <div class="modal-title" id="modalTitle"></div>

      <div class="modal-field">
        <label for="mName">Name</label>
        <input type="text" id="mName">
      </div>

      <div class="modal-field">
        <label for="mDescription">Description</label>
        <textarea id="mDescription"></textarea>
      </div>

      <div class="modal-field">
        <label for="mSource">Source</label>
        <input type="text" id="mSource">
        <a class="source-link" id="mSourceLink" href="#" target="_blank" rel="noopener"></a>
      </div>

      <div class="modal-row">
        <div class="modal-field">
          <label for="mDate">Date</label>
          <input type="date" id="mDate">
        </div>
        <div class="modal-field">
          <label for="mEvidence">Evidence</label>
          <input type="text" id="mEvidence">
        </div>
      </div>

      <label style="display:block;font-size:0.78rem;font-weight:600;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.4px;">Hypothesis Ratings</label>
      <div class="modal-h-row">
        <div class="modal-field"><label for="mH1">H1</label><select id="mH1"><option value="">-</option><option>++</option><option>+</option><option>0</option><option>-</option><option>--</option><option>N/A</option></select></div>
        <div class="modal-field"><label for="mH2">H2</label><select id="mH2"><option value="">-</option><option>++</option><option>+</option><option>0</option><option>-</option><option>--</option><option>N/A</option></select></div>
        <div class="modal-field"><label for="mH3">H3</label><select id="mH3"><option value="">-</option><option>++</option><option>+</option><option>0</option><option>-</option><option>--</option><option>N/A</option></select></div>
        <div class="modal-field"><label for="mH4">H4</label><select id="mH4"><option value="">-</option><option>++</option><option>+</option><option>0</option><option>-</option><option>--</option><option>N/A</option></select></div>
        <div class="modal-field"><label for="mH5">H5</label><select id="mH5"><option value="">-</option><option>++</option><option>+</option><option>0</option><option>-</option><option>--</option><option>N/A</option></select></div>
      </div>

      <div class="modal-field">
        <label for="mAnalysis">Analysis Description</label>
        <textarea id="mAnalysis"></textarea>
      </div>

      <div class="modal-actions">
        <button class="modal-btn" id="modalCancel" type="button">Cancel</button>
        <button class="modal-btn primary" id="modalSave" type="button">Save</button>
      </div>
    </div>
  </div>

  <script>
    var scenariosByTrend = {};
    var driversData = [];
    var saveTimer = null;
    var currentRoot = null;
    var currentModalNode = null;
    var currentModalCard = null;

    function loadSavedScenarios() {
      return fetch('/api/load-scenarios')
        .then(function (r) { return r.ok ? r.json() : []; })
        .then(function (arr) {
          if (!Array.isArray(arr)) return;
          arr.forEach(function (driverObj) {
            (driverObj.trends || []).forEach(function (trendObj) {
              if (trendObj.trend_id) {
                scenariosByTrend[trendObj.trend_id] = {
                  baseline:     trendObj.scenarios.baseline     || '',
                  plausible:    trendObj.scenarios.plausible    || '',
                  wildcard:     trendObj.scenarios.wildcard     || '',
                  preposterous: trendObj.scenarios.preposterous || ''
                };
              }
            });
          });
        })
        .catch(function () {});
    }

    function buildOutputJson() {
      return driversData.map(function (d) {
        return {
          driver_id:   d.id,
          driver_name: d.name,
          trends: d.trends.map(function (t) {
            var s = scenariosByTrend[t.id] || { baseline: '', plausible: '', wildcard: '', preposterous: '' };
            return {
              trend_id:   t.id,
              trend_name: t.name,
              scenarios: {
                baseline:     s.baseline,
                plausible:    s.plausible,
                wildcard:     s.wildcard,
                preposterous: s.preposterous
              }
            };
          })
        };
      });
    }

    function persistToServer() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(function () {
        var json = JSON.stringify(buildOutputJson(), null, 2);
        fetch('/api/save-scenarios', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: json
        }).catch(function () {});
      }, 400);
    }

    function getTrendScenarios(trendId) {
      if (!scenariosByTrend[trendId]) {
        scenariosByTrend[trendId] = { baseline: '', plausible: '', wildcard: '', preposterous: '' };
      }
      return scenariosByTrend[trendId];
    }

    function getMaxDepth(node) {
      if (!node.children || node.children.length === 0) return node.depth;
      var max = node.depth;
      node.children.forEach(function (c) {
        var d = getMaxDepth(c);
        if (d > max) max = d;
      });
      return max;
    }

    function collectAtDepth(node, targetDepth) {
      var results = [];
      if (node.depth === targetDepth) { results.push(node); return results; }
      if (node.children) {
        node.children.forEach(function (c) {
          results = results.concat(collectAtDepth(c, targetDepth));
        });
      }
      return results;
    }

    var SCENARIO_DEFS = [
      { key: 'baseline',     label: 'Baseline Scenario',     help: 'Describe how this will happen with the current trend.' },
      { key: 'plausible',    label: 'Plausible Scenario',    help: 'Might happen.' },
      { key: 'wildcard',     label: 'Wild Card Scenario',    help: 'Could happen, but unlikely.' },
      { key: 'preposterous', label: 'Preposterous Scenario', help: "Won't ever happen." }
    ];

    function buildScenarioPanel(trendId) {
      var panel = document.createElement('div');
      panel.className = 'scenario-panel';

      if (!trendId) {
        var msg = document.createElement('div');
        msg.className = 'no-trend';
        msg.textContent = 'Select a trend to enter scenarios.';
        panel.appendChild(msg);
        return panel;
      }

      var data = getTrendScenarios(trendId);

      SCENARIO_DEFS.forEach(function (def) {
        var group = document.createElement('div');
        group.className = 'scenario-group';

        var label = document.createElement('div');
        label.className = 'scenario-label';
        label.textContent = def.label + ' ';

        var helpBtn = document.createElement('button');
        helpBtn.className = 'help-btn';
        helpBtn.textContent = '?';
        helpBtn.setAttribute('type', 'button');
        var tooltip = document.createElement('div');
        tooltip.className = 'help-tooltip';
        tooltip.textContent = def.help;
        helpBtn.appendChild(tooltip);
        helpBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          var wasActive = helpBtn.classList.contains('active');
          document.querySelectorAll('.help-btn.active').forEach(function (b) { b.classList.remove('active'); });
          if (!wasActive) helpBtn.classList.add('active');
        });
        label.appendChild(helpBtn);

        var textarea = document.createElement('textarea');
        textarea.className = 'scenario-input';
        textarea.value = data[def.key] || '';
        textarea.placeholder = def.label + '\u2026';
        textarea.addEventListener('input', function () {
          data[def.key] = textarea.value;
          persistToServer();
        });

        group.appendChild(label);
        group.appendChild(textarea);
        panel.appendChild(group);
      });

      return panel;
    }

    function openTrendPopup(node, cardEl) {
      currentModalNode = node;
      currentModalCard = cardEl;
      document.getElementById('modalTitle').textContent = node.name || '(untitled)';
      document.getElementById('mName').value = node.name || '';
      document.getElementById('mDescription').value = node.description || '';
      document.getElementById('mSource').value = node.source || '';
      var linkEl = document.getElementById('mSourceLink');
      if (node.source) {
        linkEl.href = node.source;
        linkEl.textContent = node.source;
        linkEl.style.display = '';
      } else {
        linkEl.style.display = 'none';
      }
      document.getElementById('mDate').value = node.date || '';
      document.getElementById('mEvidence').value = node.evidence || '';
      document.getElementById('mH1').value = node.H1 || '';
      document.getElementById('mH2').value = node.H2 || '';
      document.getElementById('mH3').value = node.H3 || '';
      document.getElementById('mH4').value = node.H4 || '';
      document.getElementById('mH5').value = node.H5 || '';
      document.getElementById('mAnalysis').value = node.analysis_description || '';
      document.getElementById('trendModal').classList.add('open');
    }

    function closeModal() {
      document.getElementById('trendModal').classList.remove('open');
      currentModalNode = null;
      currentModalCard = null;
    }

    function saveModalChanges() {
      var n = currentModalNode;
      if (!n) return;
      n.name = document.getElementById('mName').value;
      n.description = document.getElementById('mDescription').value;
      n.source = document.getElementById('mSource').value;
      n.date = document.getElementById('mDate').value;
      n.evidence = document.getElementById('mEvidence').value;

      var hKeys = ['H1','H2','H3','H4','H5'];
      hKeys.forEach(function (k) {
        var v = document.getElementById('m' + k).value;
        if (v) { n[k] = v; } else { delete n[k]; }
      });

      var analysis = document.getElementById('mAnalysis').value;
      if (analysis) { n.analysis_description = analysis; } else { delete n.analysis_description; }

      if (currentModalCard) {
        var span = currentModalCard.querySelector('.trend-text');
        if (span) span.textContent = n.name;
      }

      if (currentRoot) {
        fetch('/api/save-evidence', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(currentRoot, null, 2)
        }).catch(function () {});
      }
      closeModal();
    }

    document.getElementById('modalCancel').addEventListener('click', closeModal);
    document.getElementById('modalSave').addEventListener('click', saveModalChanges);
    document.getElementById('trendModal').addEventListener('click', function (e) {
      if (e.target === this) closeModal();
    });
    document.getElementById('mSource').addEventListener('input', function () {
      var linkEl = document.getElementById('mSourceLink');
      if (this.value) {
        linkEl.href = this.value;
        linkEl.textContent = this.value;
        linkEl.style.display = '';
      } else {
        linkEl.style.display = 'none';
      }
    });

    function render(root) {
      currentRoot = root;
      var rowsEl = document.getElementById('rows');
      rowsEl.innerHTML = '';

      var drivers = (root.children || []).filter(function (c) { return c.depth === 1; });

      driversData = drivers.map(function (driver) {
        var maxD = getMaxDepth(driver);
        var trends = collectAtDepth(driver, maxD);
        return { id: driver.id, name: driver.name, trends: trends };
      });

      driversData.forEach(function (driver) {
        var trends = driver.trends;

        var row = document.createElement('div');
        row.className = 'group-row';

        var driverCol = document.createElement('div');
        driverCol.className = 'driver-card';
        driverCol.textContent = driver.name;

        var trendsCol = document.createElement('div');
        trendsCol.className = 'trends-stack';

        var scenarioContainer = document.createElement('div');
        var selectedTrendId = trends.length > 0 ? trends[0].id : null;

        function refreshScenario() {
          while (scenarioContainer.firstChild) scenarioContainer.removeChild(scenarioContainer.firstChild);
          scenarioContainer.appendChild(buildScenarioPanel(selectedTrendId));
        }

        if (trends.length === 0) {
          var empty = document.createElement('div');
          empty.className = 'trend-card';
          empty.innerHTML = '<span class="trend-text" style="font-style:italic;">No trends found</span>';
          trendsCol.appendChild(empty);
        } else {
          trends.forEach(function (t, idx) {
            var card = document.createElement('div');
            card.className = 'trend-card' + (idx === 0 ? ' selected' : '');
            var span = document.createElement('span');
            span.className = 'trend-text';
            span.textContent = t.name;
            card.appendChild(span);
            card.addEventListener('click', function () {
              trendsCol.querySelectorAll('.trend-card').forEach(function (c) { c.classList.remove('selected'); });
              card.classList.add('selected');
              selectedTrendId = t.id;
              refreshScenario();
              openTrendPopup(t, card);
            });
            trendsCol.appendChild(card);
          });
        }

        refreshScenario();

        row.appendChild(driverCol);
        row.appendChild(trendsCol);
        row.appendChild(scenarioContainer);
        rowsEl.appendChild(row);
      });

      document.getElementById('loadingMsg').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }

    document.addEventListener('click', function () {
      document.querySelectorAll('.help-btn.active').forEach(function (b) { b.classList.remove('active'); });
    });

    function fetchAndRender() {
      document.getElementById('loadingMsg').textContent = 'Loading drivers and trends\u2026';
      document.getElementById('loadingMsg').style.display = '';
      return loadSavedScenarios()
        .then(function () { return fetch('/data/evidence.json'); })
        .then(function (r) { return r.ok ? r.json() : Promise.reject('fetch failed'); })
        .then(render)
        .catch(function () {
          document.getElementById('loadingMsg').textContent =
            'Could not load data/evidence.json. Make sure the server is running.';
        });
    }

    document.getElementById('btnReadFile').addEventListener('click', function () {
      scenariosByTrend = {};
      driversData = [];
      fetchAndRender();
    });

    loadSavedScenarios()
      .then(function () { return fetch('/data/evidence.json'); })
      .then(function (r) { return r.ok ? r.json() : Promise.reject('fetch failed'); })
      .then(render)
      .catch(function () {
        document.getElementById('loadingMsg').textContent =
          'Could not load data/evidence.json. Make sure the server is running.';
      });
  </script>
</body>
</html>
